<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>AR Card Editor</title>
		<link rel="stylesheet" href="mui/mui.css" />
		<link rel="stylesheet" href="./common/common.css" />
		<link rel="stylesheet" href="../dist/image-clip.css" />
		<link rel="stylesheet" href="common/clip.css" />
		<!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:100,300,400,500,700,900"> -->
	</head>

	<body>
		<!-- 生成的贺卡图 -->
		<div id="final-page" class="hidden">
			<!-- 			<div id="final-card hidden">
				<img id="final-img" src="/" alt="">
			</div> -->
			<div id="shareImg">

			</div>
			<!-- 			<img class="final-back mui-icon" src="../img/RETURN.png" >
			<img class="final-next mui-icon" onclick="finalConfirm()" src="../img/NEXT.png" > -->
			<!-- 弹出的确认框 -->
			<!-- 			<div class="pop-final hidden">
			
				<div class="final-search">
					<div class="final-select">
						<input id="final-cancel" type="image" src="../img/cancel.png">
						<input id="final-apply" type="image" src="../img/apply.png">
					</div>
				</div>

			</div> -->
			<!-- <div>
			<div id="code"></div>
		</div> -->
		</div>
		<div id="portrait-screen" class="hidden">
			<img src="../img/RotateTip.png" style="position: absolute;left: 50%;top: 50%;transform: translate(-50%,-50%);" alt="">
		</div>
		<div id="main">

			<!-- <div>
			<img src="../../兑位置用图/倒数第二张.jpg" style="width: 100%;z-index: 9;" alt="">
		</div> -->
			<!-- 确定使用裁剪图片弹框 -->
			<div class="pop-main hidden" id="applyClipTip">
				<div class="search" id="applyClipTipBg">
					<div class="btn-select">
						<input class="cancel" id="cancelApplyClip" type="image" src="../img/cancel.png">
						<input class="apply" id="confirmApplyClip" type="image" src="../img/apply.png">
					</div>
				</div>
			</div>

			<!-- 确定合成图片弹框 -->
			<div class="pop-main hidden" id="applyAllTip">
				<div class="search" id="applyAllTipBg">
					<div class="btn-select">
						<input class="cancel" id="cancelApplyAll" type="image" src="../img/cancel.png">
						<input class="apply" id="confirmApplyAll" type="image" src="../img/apply.png">
					</div>
				</div>
			</div>

			<div class="clip-content">
				<img src="../img/pageLogo.png" class="clip-img" alt="">
				<div class="upload-container choose-gallery">
					<div class="upload-pretty button-three-dimen">
						<input class="uploadimg" type="file" id="targetImg">
						<!-- 上传图片 -->
						<img class="choose-button upload-btn" src="../img/UploadPhotos.png" alt="">
					</div>
					<!-- <input class="uploadimg" type="file" id="targetImg" style="visibility:hidden ;">
				<img class="choose-button upload-btn" src="../img/UploadPhotos.png" alt=""> -->
				</div>
				<div class="upload-container choose-camera">
					<div class="upload-pretty button-three-dimen">
						<input type="file" class="photograph" id="targetImgCamera" capture="camera">
						<!-- 手机拍摄 -->
						<img class="choose-button phone-btn" src="../img/PHOTOGRAPH.png" alt="">
					</div>
					<!-- <input type="file" class="photograph" id="targetImgCamera" capture="camera" style="visibility:hidden ;">
				<img class="choose-button phone-btn" src="../img/PHOTOGRAPH.png" alt=""> -->
				</div>

				<div class="img-clip"></div>

				<nav class="clip-action nav-bar nav-bar-tab hidden">
					<a class="tab-item" id="btn-reload">
						<img class="mui-icon mui-icon-arrowleft tab-icon back" src="../img/RETURN.png" alt="">
						<!-- <span class="mui-icon mui-icon-arrowleft tab-icon"></span> -->
						<span class="tab-label hidden">取消</span>
					</a>
					<a class="tab-item " id="btn-rotate-anticlockwise">
						<img class="mui-icon mui-icon-refreshempty tab-icon rotate90 left" src="../img/LEFTROTATION.png" alt="">
						<!-- <span class="mui-icon mui-icon-refreshempty tab-icon rotate90"></span> -->
						<span class="tab-label hidden">逆时针旋转</span>
					</a>
					<a class="tab-item " id="btn-rotate-clockwise">
						<img class="mui-icon mui-icon-refreshempty tab-icon right" src="../img/RIGHTROTATION.png" alt="">
						<!-- <span class="mui-icon mui-icon-refreshempty tab-icon"></span> -->
						<span class="tab-label hidden">顺时针旋转</span>
					</a>
					<a class="tab-item hidden" id="btn-maxrect">
						<span class="mui-icon mui-icon-navigate tab-icon"></span>
						<span class="tab-label hidden">最大选择</span>
					</a>
					<a class="tab-item" id="btn-verify">
						<img class="mui-icon mui-icon-checkmarkempty tab-icon next back" src="../img/NEXT.png" alt="">
						<!-- <span class="mui-icon mui-icon-checkmarkempty tab-icon"></span> -->
						<span class="tab-label hidden">确定</span>
					</a>
				</nav>
			</div>

			<div class="show-content hidden">
				<!-- <div style="display: flex;flex-wrap: wrap;"> -->
				<div class="img-wrap" id="img-wrap">
					<img class="show-img" id="show-img" data-preview-src="" data-preview-group="2">
					<!-- <img class="img-preset hidden" src="../img/PartyA/元素10.png" alt="">
					<p class="img-text hidden" id="img-text">THANK YOU</p>
					<img class="img-model hidden" src="../img/PartyA/元素04.png" alt=""> -->

					<div id="addedLogos" class="addedElements" ondrop="drop(event)" ondragover="dragover(event)">
						<!-- logo展示占位标签 -->
						<!-- <img src="/" class="addedSingleElement" id="addedLogo_0"> -->
					</div>

					<div id="addedPresetImages" class="addedElements" ondrop="drop(event)" ondragover="dragover(event)">
						<!-- PresetImage展示占位标签 -->
						<!-- <img src="/" class="addedSingleElement hidden" id="addedPresetImage_0"> -->
					</div>

					<div id="addedModels" class="addedElements" ondrop="drop(event)" ondragover="dragover(event)">
						<!-- <div id="addedModel" class="addedModelElement"></div> -->
						<!-- <div id="addedModel" class="addedModelElement"></div> -->
					</div>

					<div id="addedTexts" class="addedElements" ondrop="drop(event)" ondragover="dragover(event)">
						<!-- Text展示占位标签 -->
						<p class="addedText hidden" id="addedText_0" style="font-size: 12px;"> text </p>
					</div>
				</div>

				<div id="toolsPart" class="hidden">
					<img id="toolsPartBg" src="../img/EditorToolPart.png" />
					<p id="toolsPartTitleP" font-family="NotoSansHansMedium">SELECT LOGO</p>

					<!-- 选择logo -->
					<div id="selectLogoList" class="selectionList hidden">
						<div id="logoWrap" class="listWrap">
							<!-- <div class="singleSelection">
								<img class="unselectedIcon" onclick="SelectLogo(0)" src="../img/PartyA/unselected.png">
								<img class="selectedIcon hidden" onclick="SelectLogo(0)" src="../img/PartyA/selected.png">
								<img class="selectionImg" onclick="SelectLogo(0)" src="../img/pageLogo.png">
							</div> -->
						</div>
					</div>
					<!-- 选择预设图标 -->
					<div id="selectPresetImageList" class="selectionList hidden">
						<div id="presetImageWrap" class="listWrap">
							<!-- <div class="singleSelection">
								<img class="unselectedIcon" onclick="SelectPresetImage(0)" src="../img/PartyA/unselected.png">
								<img class="selectedIcon hidden" onclick="SelectPresetImage(0)" src="../img/PartyA/selected.png">
								<img class="selectionImg" onclick="SelectPresetImage(0)" src="../img/PartyA/PresetImage_0.png">
							</div>-->
						</div>
					</div>
					<!-- 选择模型 -->
					<div id="selectModelList" class="selectionList hidden">
						<div id="modelWrap" class="listWrap">
							<!-- 							<div class="singleSelection">
								<img class="unselectedIcon" onclick="SelectModel(0)" src="../img/PartyA/unselected.png">
								<img class="selectedIcon hidden" onclick="SelectModel(0)" src="../img/PartyA/selected.png">
								<img class="selectionImg" onclick="SelectModel(0)" src="../img/PartyA/PresetImage_0.png">
							</div>-->
						</div>
					</div>
					<!-- 选择text -->
					<div id="editTextList" class="selectionList hidden">
						<div id="textWrap" class="listWrap">
							<div id="fontSelections">
								<div id="fontSize" onclick="ShowFontEditorTool(0)" class="fontSelection">
									SIZE
								</div>
								<div id="fontWeight" onclick="ShowFontEditorTool(1)" class="fontSelection">
									WEIGHT
								</div>
								<div id="fontColour" onclick="ShowFontEditorTool(2)" class="fontSelection">
									COLOUR
								</div>
							</div>
							<div id="fontSizeSliderBg">
								<img src="../img/fontSizeSilder.png" id="fontSizeSliderBgImg" />
								<input id="fontSizeSlider" type="range" value="12" min="12" max="30" step="2" oninput="UpdateFontSizeSlider(this.value)" />
							</div>
							<!-- 字体加粗 -->
							<div id="fontSizeSliderWt" class="hidden">

								<img id="weightImg" src="../img/fontSizeSliderThumb.png">
								<span style="width: 15px;height: 15px;position: absolute;left: 32%;" onclick="UpdateFontWeightSlider(0)"></span>
								<span style="width: 15px;height: 15px;position: absolute;left: 57%;" onclick="UpdateFontWeightSlider(1)"></span>
							</div>
							<!-- 字体颜色 -->
							<div id="fontSizeSliderCr">
								<span id="color-first" onclick="UpdateFontColorSlider(0)"></span>
								<span id="color-second" onclick="UpdateFontColorSlider(1)"></span>
								<span id="color-third" onclick="UpdateFontColorSlider(2)"></span>
								<span></span>
								<span></span>
								<span></span>
							</div>

							<!-- <input id="fontColourSlider" type="range" defaultvalue="0" min="0" max="1" step="0.1" oninput="UpdateFontSizeSlider(this.value)" /> -->
							<!-- 输入框 -->
							<input type="text" onfocus="OnTextInputFocusIn()" onblur="EditorTextDone(value)" id="edit-content" value="THANK YOU" />
						</div>
					</div>

				</div>
				<!-- </div> -->


				<nav class="nav-bar nav-bar-tab">
					<a class="tab-item" id="btn-back">
						<img src="../img/RETURN.png" class="mui-icon mui-icon-arrowleft tab-icon best1" alt="">
						<!-- <span class="mui-icon mui-icon-arrowleft tab-icon"></span> -->
						<span class="tab-label hidden">返回上一步</span>
					</a>
					<!-- 这是新加的三个 -->
					<a class="tab-item" id="btn-logo">
						<img src="../img/LOGO.png" class="mui-icon mui-icon-arrowleft tab-icon best2" alt="">
						<!-- <span class="mui-icon mui-icon-arrowleft tab-icon"></span> -->
						<span class="tab-label hidden">LOGO</span>
					</a>
					<a class="tab-item" id="btn-presetImages">
						<img src="../img/PRESETIMAGES.png" class="mui-icon mui-icon-arrowleft tab-icon best3" alt="">
						<!-- <span class="mui-icon mui-icon-arrowleft tab-icon"></span> -->
						<span class="tab-label hidden">预置图片</span>
					</a>
					<a class="tab-item" id="btn-model">
						<img src="../img/MODEL.png" class="mui-icon mui-icon-arrowleft tab-icon best4" alt="">
						<!-- <span class="mui-icon mui-icon-arrowleft tab-icon"></span> -->
						<span class="tab-label hidden">模型</span>
					</a>
					<!-- 这是新加的三个 -->
					<a class="tab-item" id="btn-text">
						<img src="../img/TEXT.png" class="mui-icon mui-icon-more-filled tab-icon best5" alt="">
						<!-- <span class="mui-icon mui-icon-more-filled tab-icon"></span> -->
						<span class="tab-label hidden">文本</span>
					</a>
					<a class="tab-item" id="btn-save">
						<img src="../img/NEXT.png" class="mui-icon mui-icon-more-filled tab-icon best6" alt="">
						<!-- <span class="mui-icon mui-icon-checkmarkempty tab-icon"></span> -->
						<span class="tab-label hidden">下一步</span>
					</a>
				</nav>
			</div>
		</div>

		<!-- <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:100,300,400,500,700,900"> -->
		<script type="text/javascript" src="./common/fileinput.js"></script>
		<script type="text/javascript" src="./common/exif.js"></script>
		<script type="text/javascript" src="./../dist/image-clip.js"></script>
		<script type="text/javascript" src="../js/jquery-3.5.1/jquery-3.5.1.min.js"></script>
		<script type="text/javascript" src="../js/flexible.js"></script>
		<script type="text/javascript" src="../js/html2canvas.js"></script>
		<script type="text/javascript" src="../js/jquery-ui.min.js"></script>
		<script type="text/javascript" src="../js/jquery.ui.touch-punch.min.js"></script>
		<script type="text/javascript" src="../js/three.js"></script>
		<script type="text/javascript" src="../js/GLTFLoader.js"></script>
		<script type="text/javascript" src="../js/OrbitControls.js"></script>

		<script>
			//域名
			var domainName = "https://webar.esquel.cn/";
			// var domainName = "https://molion.tech/test/YiDaAR/";

			//软键盘弹出
			function OnTextInputFocusIn() {
				CloseAllFontEditorTools();
				$("#fontSelections").addClass('hidden');
				// $("#fontSizeSliderBg").addClass('hidden');
				$('.img-wrap').addClass('hidden');
				$('.nav-bar').addClass('hidden');
				$("#edit-content").css("top", "30%");
				console.log("软键盘弹出");
			}

			//软键盘收回
			function OnTextInputFocusOut() {
				ShowFontEditorTool(currentFontEditorToolIdx);
				$('#fontSelections').removeClass('hidden');
				// $('#fontSizeSliderBg').removeClass('hidden');
				$('.img-wrap').removeClass('hidden');
				$('.nav-bar').removeClass('hidden');
				$("#edit-content").css("top", "55%");
				console.log("软键盘收回");
			}


			// 设置拖动范围
			function SetDraggableArea(dom, isNeedToCaculateDomSize, cursorLeftOffset, cursorTopOffset) {

				console.log("SetDraggableArea");
				if (isNeedToCaculateDomSize) {
					console.log("dom.width()", dom.width());

					cursorLeftOffset = dom.width() / 20;
					cursorTopOffset = dom.height() / 20;
					//左上角
					var containment_X_1 = $("#img-wrap").offset().left;
					console.log("containment_X_1", containment_X_1);
					var containment_Y_1 = $("#img-wrap").offset().top;
					//右下角
					var containment_X_2 = $("#img-wrap").offset().left + $("#img-wrap").width();
					var containment_Y_2 = $("#img-wrap").offset().top + $("#img-wrap").height();
				} else {
					//左上角
					var containment_X_1 = $("#img-wrap").offset().left;
					var containment_Y_1 = $("#img-wrap").offset().top;
					//右下角
					var containment_X_2 = containment_X_1 + $("#img-wrap").width();
					var containment_Y_2 = containment_Y_1 + $("#img-wrap").height();
				}
				//设置拖动范围
				dom.draggable({
					containment: [containment_X_1, containment_Y_1, containment_X_2, containment_Y_2],
					cursorAt: {
						left: cursorLeftOffset,
						top: cursorTopOffset
					},
				});
			}


			//关闭其他页面
			function CloseOtherTools() {
				$('#selectLogoList').addClass("hidden");
				$('#selectPresetImageList').addClass("hidden");
				$('#selectModelList').addClass("hidden");
				$('#editTextList').addClass("hidden");
			}

			var modelLoaded = false;
			// 显示右侧工具栏
			function ShowToolList(idx) {
				CloseOtherTools();

				//先显示元素，$('#toolsPart').width()才有值
				$('#toolsPart').removeClass("hidden");
				//背景图左移
				var ratio = parseFloat($('#img-wrap').css("width")) / parseFloat($('#img-wrap').css("height"));
				var imgWrapHeight = parseFloat($('#toolsPartBg').css("height"));
				var imgWrapWidth = imgWrapHeight * ratio;
				$('#img-wrap').css("height", imgWrapHeight);
				$('#img-wrap').css("width", imgWrapWidth);
				var imgWrapTop = (window.innerHeight - parseFloat($('.nav-bar').css("height")) - imgWrapHeight) / 2;
				// console.log("imgWrapLeft???", $('#toolsPart').offset().left);
				// console.log("imgWrapLeft!!!", $('#toolsPart').offset().left - imgWrapWidth);
				var imgWrapLeft = ($('#toolsPart').offset().left - imgWrapWidth) / 2;
				// console.log("imgWrapLeft: ", imgWrapLeft);
				$('#img-wrap').css("top", imgWrapTop);
				$('#img-wrap').css("left", imgWrapLeft);

				if (idx == 0) {
					//显示logo编辑页面
					document.querySelector('#toolsPartTitleP').innerText = "SELECT LOGO";
					$('#selectLogoList').removeClass("hidden");

					// console.log('logo被点击')
				} else if (idx == 1) {
					//显示presetImage编辑页面
					document.querySelector('#toolsPartTitleP').innerText = "SELECT PRESET IMAGE";
					$('#selectPresetImageList').removeClass("hidden");

					// console.log('presetImage被点击')
				} else if (idx == 2) {
					//显示model编辑页面
					document.querySelector('#toolsPartTitleP').innerText = "SELECT MODEL";
					$('#selectModelList').removeClass("hidden");

					// 加载模型
					initialLoad();
					// console.log('model被点击')
				} else if (idx == 3) {
					//显示text编辑页面
					document.querySelector('#toolsPartTitleP').innerText = "EDITOR TEXT";
					$('#editTextList').removeClass("hidden");
					//在背景图上显示文本元素
					$("#addedText_0").removeClass("hidden");
					$("#addedText_0").html($("#edit-content").val());

					// 设置拖动范围
					SetDraggableArea($("#addedText_0"), false, 0, 5);
					//默认编辑SIZE
					ShowFontEditorTool(0);

					// console.log('text被点击')
				}
			}

			// 选择logo图标
			function SelectLogo(idx) {
				// console.log(idx);
				// console.log("length",document.getElementById('logo-wrap').children.length);
				// console.log("??" + $('#logo-wrap').children);
				if (idx < logoIconCount) {
					// document.getElementById('show-logo').src = logoPath;
					// console.log('type',	typeof(document.getElementById('logo-wrap').children[idx].children[0]));
					// console.log(document.getElementById('logo-wrap').children[idx].children[0].className);

					var newDomId = "addedLogo_" + idx;
					//检测是否选中
					if (CheckIfSelected($('#logoWrap').children().eq(idx)) == true) {
						//添加元素，样例 <img src="/" id="addedLogo_0" class="addedSingleElement">
						// 不存在，生成新的
						if (CheckIfCreated(newDomId) == false) {
							var newDomBgUrl = domainName + "ARCardAssets/" + cid + "/Logo/Logo_" + idx + ".png";
							var newDivDom = $('<div class="addedSingleElementDiv"></div>');
							var newDom = $('<img src="' + newDomBgUrl + '" id="' + newDomId +
								'" class="addedSingleElement">');

							// console.log(0);
							// 图片加载完设置拖动范围
							$(newDom).on('load', function() {
								SetDraggableArea($(newDom), true, 0, 0);
							});

							$("#addedLogos").append($(newDivDom));
							$(newDivDom).append($(newDom));
						}
						// 存在，不再生成，改为显示
						else {
							$('#' + newDomId).removeClass("hidden");
						}
					} else {
						//取消选中
						//同时隐藏元素
						HideSelected(newDomId);
					}

					// showLogo.style.src = logoPath;
					// showLogo.classList.remove('hidden')
				}
			}

			// 选择PresetImage图标
			function SelectPresetImage(idx) {
				// console.log("SelectPresetImage: " + idx);
				if (idx < presetImageCount) {
					var newDomId = "addedPresetImage_" + idx;
					// console.log("length",$('#modelWrap').children().length);
					//检测是否选中
					if (CheckIfSelected($('#presetImageWrap').children().eq(idx)) == true) {
						//添加元素，样例 <img src="/" id="addedPresetImage_0" class="addedSingleElement">
						// 不存在，生成新的
						if (CheckIfCreated(newDomId) == false) {
							var newDomBgUrl = domainName + "ARCardAssets/" + cid + "/Element_2D/Image_" + idx + ".png";
							var newDivDom = $('<div class="addedSingleElementDiv"></div>');
							var newDom = $('<img src="' + newDomBgUrl + '" id="' + newDomId +
								'" class="addedSingleElement">');

							// 图片加载完设置拖动范围
							$(newDom).on('load', function() {
								SetDraggableArea($(newDom), true, 0, 0);
							});

							$("#addedPresetImages").append($(newDivDom));
							$(newDivDom).append($(newDom));
						}
						// 存在，不再生成，改为显示
						else {
							$('#' + newDomId).removeClass("hidden");
						}
					} else {
						//同时隐藏元素
						HideSelected(newDomId);
					}
				}
			}

			// 选择model图标
			function SelectModel(idx) {
				if (idx < modelCount) {
					var newDomId = "addedModel_" + idx;
					//检测是否选中
					if (CheckIfSelected($('#modelWrap').children().eq(idx)) == true) {
						//显示对应模型
						$("#" + newDomId).removeClass("hidden");

					} else {
						console.log(newDomId)
						//隐藏对应模型
						$("#" + newDomId).addClass("hidden");
					}
				}
			}

			//关闭其他字体工具
			function CloseAllFontEditorTools() {
				$("#fontSize").removeClass("active");
				$("#fontSizeSliderBg").addClass("hidden");

				$("#fontWeight").removeClass("active");
				$("#fontSizeSliderWt").addClass("hidden");

				$("#fontColour").removeClass("active");
				$("#fontSizeSliderCr").addClass('hidden');
			}

			var currentFontEditorToolIdx;
			//显示字体工具
			function ShowFontEditorTool(idx) {
				CloseAllFontEditorTools();
				//改变字体大小
				if (idx == 0) {
					$("#fontSize").addClass("active");
					$("#fontSizeSliderBg").removeClass("hidden");
				} //改变字体粗细
				else if (idx == 1) {
					$("#fontWeight").addClass("active");
					$("#fontSizeSliderWt").removeClass("hidden");

				} //改变字体颜色
				else if (idx == 2) {
					$("#fontColour").addClass("active");
					$("#fontSizeSliderCr").removeClass("hidden");
				}
				currentFontEditorToolIdx = idx;
			}

			// 修改text内容
			function EditorTextDone(str) {
				$("#addedText_0").html(str);
				//收回软键盘
				OnTextInputFocusOut();
			}

			// 改变字体大小
			function UpdateFontSizeSlider(value) {
				// console.log("UpdateFontSizeSlider", value);
				// console.log(typeof(value));
				$("#addedText_0").css({
					fontSize: value + "px"
				});
			}
			// 改变字体正长或者加粗
			function UpdateFontWeightSlider(value) {
				console.log(value);
				if (value == 0) {
					$("#weightImg").css({
						left: 32 + '%'
					});
					$("#addedText_0").css("font-weight", "normal");
					// $("#addedText_0").css("font-family", "thin");

				} else {
					$("#weightImg").css({
						left: 57 + '%'
					});
					$("#addedText_0").css("font-weight", "bold");
					// $("#addedText_0").css("font-family", "bold");
				}
			}

			// 改变字体颜色
			function UpdateFontColorSlider(value) {
				console.log("value：", value);
				if (value == 0) {
					$("#color-first").css("transform", "scale(1.3)");
					$("#color-second").css("transform", "scale(1)");
					$("#color-third").css("transform", "scale(1)");
					$("#addedText_0").css("color", "#FB7E00");
				} else if (value == 1) {
					$("#color-first").css("transform", "scale(1)");
					$("#color-third").css("transform", "scale(1)");
					$("#color-second").css("transform", "scale(1.3)");
					$("#addedText_0").css("color", "#2F47D6");
				} else if (value == 2) {
					$("#color-first").css("transform", "scale(1)");
					$("#color-second").css("transform", "scale(1)");
					$("#color-third").css("transform", "scale(1.3)");
					$("#addedText_0").css("color", "#8A4797");
				}
			}
			//判断是否选中，同时切换选中icon
			function CheckIfSelected(el) {
				// console.log("checkIfSelected", el);
				//未选中，显示选中，字符串不包含会返回-1
				// console.log(el.children[0].className.indexOf("hidden"));
				if (el.children().eq(0).hasClass("hidden") == false) {
					// console.log("return true");
					//隐藏未选中
					el.children().eq(0).addClass("hidden");
					//显示选中
					el.children().eq(1).removeClass("hidden");
					return true;
				}
				//否则显示未选中
				else {
					// console.log("return false");
					//显示未选中
					el.children().eq(0).removeClass("hidden");
					//隐藏选中
					el.children().eq(1).addClass("hidden");
					return false;
				}
			}
			//判断是否已生成元素
			function CheckIfCreated(id) {
				//存在
				if ($('#' + id).length > 0) {
					return true;
				}
				//不存在
				else {
					return false;
				}
			}

			//隐藏
			function HideSelected(id) {
				// console.log(id, '关闭')
				$("#" + id).addClass("hidden");
			}

			// 拖动释放事件
			$("#img-wrap").droppable({
				drop: function(event, ui) {
					$(this).addClass("isDropped");
					// $(this).css({position: "absolute"});
					// console.log($(this).css("position"));
				}
			});

			// 选择字体正常或者粗体
			function chooseWeight(type) {
				if (type == 0) {
					imgText.style.cssText = "font-weight: bold;";
				} else {
					imgText.style.cssText = "font-weight: normal;";
				}
			};
			// 选择字体颜色
			function chooseColor(color) {
				if (color == 0) {
					imgText.style.cssText = "color: red;";
				} else {
					imgText.style.cssText = "color:pink";
				}
			};

			var originalWidth = document.documentElement.clientWidth;
			var originalHeight = document.documentElement.clientHeight;
			//强制横屏
			var detectOrient = function() {
				// console.log("detectOrient", document.documentElement.clientHeight);
				var width = document.documentElement.clientWidth,
					height = document.documentElement.clientHeight,
					wrapper = document.getElementById("main"),
					style = "";
				if (width >= height) {
					// 横屏
					style += "width:" + width + "px;";
					style += "height:" + height + "px;";
					style += "-webkit-transform: rotate(0); transform: rotate(0);";
					style += "-webkit-transform-origin: 0 0;";
					style += "transform-origin: 0 0;";
					document.querySelector('#portrait-screen').classList.add('hidden')
					if (isCardCreated) {
						document.querySelector('#final-page').classList.remove('hidden')
					}
					// console.log("style 0: ", style);
					isLandScape = true;
					// console.log("isWaitingToShowPhoto: " + isWaitingToShowPhoto);
					//竖屏拍照后，旋转至横屏再处理
					if (isWaitingToShowPhoto == true) {
						console.log("竖屏拍照后，旋转至横屏再处理");
						loadImg(img_b64);
						isWaitingToShowPhoto = false;
					}
					//显示生成的图片时，不显示main
					if ($("#final-page").hasClass("hidden")) {
						document.querySelector('#main').classList.remove('hidden')
					}
				} else {
					// 竖屏
					style += "width:" + height + "px;"; // 注意旋转后的宽高切换
					style += "height:" + width + "px;";
					style += "-webkit-transform: rotate(90deg); transform: rotate(90deg);";
					// 注意旋转中点的处理
					style += "-webkit-transform-origin: " + width / 2 + "px " + width / 2 + "px;";
					style += "transform-origin: " + width / 2 + "px " + width / 2 + "px;";
					document.querySelector('#portrait-screen').classList.remove('hidden')
					document.querySelector('#main').classList.add('hidden')
					if (isCardCreated) {
						document.querySelector('#final-page').classList.add('hidden')
					}
					console.log("style 1: ", style);
					isLandScape = false;
				}
				wrapper.style.cssText = style;
			}
			// window.onload = detectOrient;
			window.onresize = detectOrient;
			detectOrient();

			var chooseGallery;
			var chooseCamera;
			var cropImage;
			var imgData;
			var clipContent;
			var clipAction;
			var showContent;
			var showImg;
			var targetImg;
			var targetImgCamera;
			// 接受后端传过来的数据
			var greetingCardUrl;
			// var finalimg;
			var shareImgdom;
			//图片缓存数据
			var img_b64;
			//---------------
			//------bool-----
			//---------------
			// 判断是否在成品页面，控制生成图片Div显隐
			var isCardCreated;
			//判断横竖屏
			var isLandScape;
			var isWaitingToShowPhoto;
			var isPortartScreen;
			// 控制编图片页面元素的显隐
			var isShowLogo;
			var isShowText;
			var isShowModel;
			//logo节点对象
			var imgPreset;
			var imgText;
			var imgModel;
			// 截图上面的logo对象
			var showLogo;
			// preset-list div对象
			var presetList;
			// 控制图标选中与未选中
			var isShowFirst;
			var isShowSecond;
			var isShowThird;
			var isShowFourth;
			var isShowFifth;
			var isShowSixth;
			var isShowSeventh;
			var isShowEighth;
			var isShowNinth;
			var isShowTenth;
			// text-edit对象
			var textEdit;
			// 模型的宽高
			var cardWidth;
			var cardHeight;
			// 存储后台获取的元素数量
			var logoIconCount;
			var presetImageCount;
			var modelCount;
			// 模型相对于父物体位置
			var modelPos_X;
			var modelPos_Y;

			var cid;
			var uid;

			initPage();

			function initPage() {
				initParams();
				initListeners();
				initImgClip();
				getIconData();
			}
			// 加载页面请求icon的数据
			function getIconData() {
				var formData = new FormData();

				// var searchURL;
				// searchURL = searchURL.substring(1, searchURL.length);
				var searchURL = window.location.search;
				// var searchURL = 'http://molion.tech/test/YiDaAR/ARCard/examples/index.html?cid=01&uid=G7i.K37s6Sidy';
				uid = searchURL.split("&")[1].split("=")[1];
				cid = searchURL.split("&")[0].split("=")[1];
				cid = parseInt(cid).toString();
				// cid = 0;
				formData.append("cid", cid);
				$.ajax({
					url: domainName + 'yida-ar-admin/public/index.php/getResourcesNum',
					async: false,
					type: "POST",
					data: formData,
					dataType: "json",
					processData: false,
					contentType: false,
					success: function(data) {
						console.log(data);
						presetImageCount = data["data"][cid]["Element_2D"];
						modelCount = data["data"][cid]["Element_3D"];
						logoIconCount = data["data"][cid]["Logo"];

						initIcons(cid);
					},
					error: function(xhr) {
						console.log("error", xhr);
					}
				});
			}
			//加载元素图标
			function initIcons(cid) {
				// <div class="singleSelection">
				// 								<img class="unselectedIcon" onclick="SelectLogo(0)" src="../img/PartyA/unselected.png">
				// 								<img class="selectedIcon hidden" onclick="SelectLogo(0)" src="../img/PartyA/selected.png">
				// 								<img class="selectionImg" onclick="SelectLogo(0)" src="../img/pageLogo.png">
				// 							</div>
				//添加元素，样例 <img src="/" id="addedModel_0" class="addedSingleElement">
				if (logoIconCount > 0) {
					for (var i = 0; i < logoIconCount; i++) {
						var idx = i;
						var url = domainName + 'ARCardAssets/Icon_' + cid + '/Logo/Logo_' + idx + '.jpg';
						var newDomBgUrl = domainName + "ARCardAssets/01/Element_2D/Image_" + idx + ".png";
						var newDivDom = $('<div class="singleSelection"></div>');
						var newDom_0 = $('<img class="unselectedIcon" onclick="SelectLogo(' + idx +
							')" src="../img/PartyA/unselected.png">');
						var newDom_1 = $('<img class="selectedIcon hidden" onclick="SelectLogo(' + idx +
							')" src="../img/PartyA/selected.png">');
						var newDom_2 = $('<img class="selectionImg" onclick="SelectLogo(' + idx + ')" src="' + url + '">');

						$("#logoWrap").append($(newDivDom));
						$(newDivDom).append($(newDom_0));
						$(newDivDom).append($(newDom_1));
						$(newDivDom).append($(newDom_2));
					}
				}

				// 加载预置图片
				// <div id="presetImageWrap" class="listWrap">
				// 	<div class="singleSelection">
				// 		<img class="unselectedIcon" onclick="SelectPresetImage(0)" src="../img/PartyA/unselected.png">
				// 		<img class="selectedIcon hidden" onclick="SelectPresetImage(0)" src="../img/PartyA/selected.png">
				// 		<img class="selectionImg" onclick="SelectPresetImage(0)" src="../img/PartyA/PresetImage_0.png">
				// 	</div>
				if (presetImageCount > 0) {
					// 遍历加载预置图片
					for (var i = 0; i < presetImageCount; i++) {
						var idx = i;
						var url = domainName + 'ARCardAssets/Icon_' + cid + '/Element_2D/Image_' + idx + '.jpg';
						// console.log(url)
						var preDivDom = $('<div class="singleSelection"></div>');
						var preImg_0 = $('<img class="unselectedIcon" onclick="SelectPresetImage(' + idx +
							')" src="../img/PartyA/unselected.png">');
						// console.log(preImg_0)
						var preImg_1 = $('<img class="selectedIcon hidden" onclick="SelectPresetImage(' + idx +
							')" src="../img/PartyA/selected.png">');
						// console.log(preImg_1)
						var preImg_2 = $('<img class="selectionImg" onclick="SelectPresetImage(' + idx +
							')" src="' + url + '">');
						// console.log(preImg_2)
						$("#presetImageWrap").append($(preDivDom));
						$(preDivDom).append($(preImg_0));
						$(preDivDom).append($(preImg_1));
						$(preDivDom).append($(preImg_2));
					}
				}

				// 加载模型
				// <div id="modelWrap" class="listWrap">
				// 	<div class="singleSelection">
				// 		<img class="unselectedIcon" onclick="SelectModel(0)" src="../img/PartyA/unselected.png">
				// 		<img class="selectedIcon hidden" onclick="SelectModel(0)" src="../img/PartyA/selected.png">
				// 		<img class="selectionImg" onclick="SelectModel(0)" src="../img/PartyA/PresetImage_0.png">
				// 	</div>
				// console.log("modelCount", modelCount);
				if (modelCount > 0) {
					// 遍历加载模型图片
					for (var i = 0; i < modelCount; i++) {
						var idx = i;
						var url = domainName + 'ARCardAssets/Icon_' + cid + '/Element_3D/Model_' + idx + '.jpg';
						// console.log("url",url);
						var modelIconDivDom = $('<div class="singleSelection"></div>');
						var modelImg_0 = $('<img class="unselectedIcon" onclick="SelectModel(' + idx +
							')" src="../img/PartyA/unselected.png">');
						var modelImg_1 = $('<img class="selectedIcon hidden" onclick="SelectModel(' + idx +
							')" src="../img/PartyA/selected.png">');
						var modelImg_2 = $('<img class="selectionImg" onclick="SelectModel(' + idx + ')" src="' + url + '">');
						$("#modelWrap").append($(modelIconDivDom));
						$(modelIconDivDom).append($(modelImg_0));
						$(modelIconDivDom).append($(modelImg_1));
						$(modelIconDivDom).append($(modelImg_2));
					}
					// console.log("!!!",$("#img-wrap").children().length);
					// console.log("???",$("#addedModels").children().length);
				}
			}

			function initParams() {
				targetImg = document.querySelector('#targetImg');
				targetImgCamera = document.querySelector('#targetImgCamera');
				chooseGallery = document.querySelector('.choose-gallery');
				chooseCamera = document.querySelector('.choose-camera');
				clipContent = document.querySelector('.clip-content');
				clipAction = document.querySelector('.clip-action');
				showContent = document.querySelector('.show-content');
				// 修改后的图片父元素
				imgWrap = document.querySelector('.img-wrap')
				showImg = document.querySelector('.show-img');
				// 添加的代码
				main = document.querySelector('#main');
				finalpage = document.querySelector('#final-page');
				// popmain = document.querySelector('.pop-main');
				// finalimg = document.querySelector('#final-img');
				shareImgdom = document.querySelector('#shareImg')
				// logo对象
				imgPreset = document.querySelector('.img-preset')
				//model对象
				imgModel = document.querySelector('.img-model')
				// 图片上的文本对象
				imgText = document.querySelector('.img-text')
				//展示编辑的文本对象
				textEdit = document.querySelector('#text-edit')
				//布尔开关
				isCardCreated = false;
				isLandScape = false;
				isWaitingToShowPhoto = false;
				//preset-list 对象
				presetList = document.querySelector('.preset-list')
				// logo的显隐
				isShowLogo = true;
				//model的显隐
				isShowModel = true;
				// 文本的显隐
				isShowText = true;

				isShowFirst = true;
				isShowSecond = true;
				isShowThird = true;
				isShowFourth = true;
				isShowFifth = true;
				isShowSixth = true;
				isShowSeventh = true;
				isShowEighth = true;
				isShowNinth = true;
				isShowTenth = true;
				// css
				finalpage.style.cssText = "position: absolute;width: 100%;height: 100%;";
			}

			//初始化从相册选择的图片
			function initImgClip() {
				new FileInput({
					container: '#targetImg',
					isMulti: false,
					type: 'Image_Camera',
					success: function(b64, file, detail) {
						// console.log("选择:" + b64);
						console.log("fileName:" + file.name);

						loadImg(b64);
					},
					error: function(error) {
						console.error(error);
					}
				});
				new FileInput({
					container: '#targetImgCamera',
					isMulti: false,
					type: 'Camera',
					success: function(b64, file, detail) {
						img_b64 = b64;
						//横屏，直接显示
						if (isLandScape) {
							console.log("isLandScape fileName:" + file.name);
							loadImg(img_b64);
						}
						//竖屏，等待变成横屏
						else {
							isWaitingToShowPhoto = true;
						}
					},
					error: function(error) {
						console.error(error);
					}
				});
			}

			function loadImg(b64) {
				changeImgClipShow(true);

				var img = new Image();
				img.src = b64;
				// console.log(img.width,img.height);
				img.onload = function() {
					EXIF.getData(img, function() {
						console.log("loadImg onload");
						// 把logo隐藏
						document.querySelector('.clip-img').classList.add('hidden');
						var orientation = EXIF.getTag(this, 'Orientation');

						cropImage && cropImage.destroy();
						cropImage = new ImageClip({
							container: '.img-clip',
							img,
							// 0代表按下才显示，1恒显示，-1不显示
							sizeTipsStyle: 0,
							// 为1一般是屏幕像素x2这个宽高
							// 最终的大小为：屏幕像素*屏幕像素比（手机中一般为2）*compressScaleRatio
							compressScaleRatio: 1.1,
							// iphone中是否继续放大：x*iphoneFixedRatio
							// 最好compressScaleRatio*iphoneFixedRatio不要超过2
							iphoneFixedRatio: 1.8,
							// 减去顶部间距，底部bar,以及显示间距 
							// maxCssHeight: window.innerHeight - 100 - 50 - 20,
							maxCssHeight: window.innerHeight - 50 - 50 - 20,
							// 放大镜捕获的图像半径
							captureRadius: 30,
							// 是否采用原图像素（不会压缩）
							isUseOriginSize: true,
							// 增加最大宽度，增加后最大不会超过这个宽度
							// maxWidth: 0,
							maxWidth: document.documentElement.clientWidth,

							// 是否固定框高，优先级最大，设置后其余所有系数都无用直接使用这个固定的宽，高度自适应
							forceWidth: 0,
							// 同上，但是一般不建议设置，因为很可能会改变宽高比导致拉升，特殊场景下使用
							forceHeight: 0,
							// 压缩质量
							quality: 0.92,
							mime: 'image/jpeg',
						});

						// 6代表图片需要顺时针修复（默认逆时针处理了，所以需要顺过来修复）
						switch (orientation) {
							case 6:
								cropImage.rotate(true);
								break;
							default:
								break;
						}

						//让clip-content上下顶到头
						// console.log("window.document.clientHeight", window.innerHeight);
						// console.log("clip-action height", $('.clip-action').css('height'));
						var clipContentHeight = parseFloat(window.innerHeight - $('.clip-action').css('height'));
						$(".clip-content").css("height", clipContentHeight);
						$(".clip-content").css("bottom", $('.clip-action').css('height'));
					});
				};
			}

			function resizeShowImg(b64) {
				var img = new Image();
				img.src = b64;
				// console.log("resizeShowImg width", img.width);
				// console.log("resizeShowImg height", img.height);
				img.onload = function() {
					showImgOnload(img);
				}
				// img.onload = showImgOnload;
			}

			function showImgOnload(img) {
				// console.log("showImgOnload");
				// 必须用一个新的图片加载，否则如果只用showImg的话永远都是第1张
				// margin的话由于有样式，所以自动控制了
				// var width = this.width;
				// var height = this.height;
				var width = img.width;
				var height = img.height;
				console.log("showImgOnload width", width);
				console.log("showImgOnload height", height);
				var wPerH = width / height;
				console.log("showImgOnload wPerH", wPerH);
				var MAX_WIDTH = Math.min(window.innerWidth, width);
				var MAX_HEIGHT = Math.min(window.innerHeight - 50 - 80, height);
				var legalWidth = MAX_WIDTH;
				var legalHeight = legalWidth / wPerH;
				console.log("legalWidth", legalWidth);
				console.log("legalHeight", legalHeight);

				if (MAX_WIDTH && legalWidth > MAX_WIDTH) {
					legalWidth = MAX_WIDTH;
					legalHeight = legalWidth / wPerH;
				}
				if (MAX_HEIGHT && legalHeight > MAX_HEIGHT) {
					legalHeight = MAX_HEIGHT;
					legalWidth = legalHeight * wPerH;
				}
				// cardWidth = legalWidth;
				// cardHeight = legalHeight;
				// console.log("cardWidth", cardWidth);
				// console.log("cardHeight", cardHeight);
				//让裁剪后的图片居中
				$('#img-wrap').css('right', (window.innerWidth - legalWidth) / 2 + 'px');
				// console.log($('.show-content').height());
				$('#img-wrap').css('top', ($('.show-content').height() - legalHeight) / 2 + 'px');

				// var marginTop = (window.innerHeight - 50 - legalHeight) / 2;
				// showImg.style.marginTop = marginTop + 'px';
				// imgWrap.style.padding = marginTop + 'px';
				imgWrap.style.width = legalWidth + 'px';
				imgWrap.style.height = legalHeight + 'px';
			}

			function changeImgClipShow(isClip) {
				if (isClip) {
					chooseGallery.classList.add('hidden');
					chooseCamera.classList.add('hidden');
					clipAction.classList.remove('hidden');
				} else {
					chooseGallery.classList.remove('hidden');
					chooseCamera.classList.remove('hidden');
					clipAction.classList.add('hidden');
					// 需要改变input，否则下一次无法change
					targetImg.value = '';
					targetImgCamera.value = '';
				}
			}

			function initListeners() {
				console.log("initListeners");

				document.querySelector('#btn-reload').addEventListener('click', function() {
					document.querySelector('.clip-img').classList.remove('hidden')
					cropImage && cropImage.destroy();
					changeImgClipShow(false);
				});
				document.querySelector('#btn-back').addEventListener('click', function() {
					// 回退上一页时隐藏展示模型的父级
					// $('#addedModels').addClass('hidden');
					// imgPreset.classList.add('hidden');
					// isShowLogo = true;
					// imgModel.classList.remove('hidden');
					// isShowModel = true;
					// imgText.classList.add('hidden');
					// isShowText = true;
					changeContent(false);
				});
				document.querySelector('#btn-save').addEventListener('click', function() {
					//显示提示弹框
					$('#applyAllTip').removeClass("hidden");
				});
				document.querySelector('#cancelApplyAll').addEventListener('click', function() {
					$("#applyAllTip").addClass("hidden");
				});
				document.querySelector('#confirmApplyAll').addEventListener('click', function() {
					$("#applyAllTip").addClass("hidden");

					// 保存模型位置
					getModelPos();
					//再隐藏展示模型的父级
					$('#addedModels').addClass('hidden');
					//保存截图
					saveScreenShot();
				});
				// document.querySelector('#btn-detail').addEventListener('click', function () {
				// 	showImgDataLen(imgData);
				// });
				// 监听btn-logo按钮的点击
				document.querySelector('#btn-logo').addEventListener('click', function() {
					ShowToolList(0);
				});
				// 监听PRESET IMAGES按钮的点击
				document.querySelector('#btn-presetImages').addEventListener('click', function() {
					ShowToolList(1);
				});
				//监听model按钮的点击
				document.querySelector('#btn-model').addEventListener('click', function() {
					ShowToolList(2);
				});
				// 监听text按钮的点击
				document.querySelector('#btn-text').addEventListener('click', function() {
					ShowToolList(3);
				});
				document.querySelector('#btn-maxrect').addEventListener('click', function() {
					if (!cropImage) {
						tips('请选择图片');
						return;
					}
					cropImage.resetClipRect();
				});

				document.querySelector('#btn-rotate-anticlockwise').addEventListener('click', function() {
					if (!cropImage) {
						tips('请选择图片');
						return;
					}
					cropImage.rotate(false);
				});

				document.querySelector('#btn-rotate-clockwise').addEventListener('click', function() {
					if (!cropImage) {
						tips('请选择图片');
						return;
					}
					cropImage.rotate(true);
				});

				document.querySelector('#btn-verify').addEventListener('click', function() {
					if (!cropImage) {
						tips('请选择图片');
						return;
					}
					// popmain.classList.remove('hidden');
					//显示提示弹框
					$('#applyClipTip').removeClass("hidden");

					//编辑图片界面居中
					var contentHeight = window.innerHeight - parseFloat($(".clip-action").css("height"));
					$(".show-content").css("height", contentHeight);
				});
				document.querySelector('#cancelApplyClip').addEventListener('click', function() {
					//隐藏提示框
					$("#applyClipTip").addClass("hidden");
				});
				//确认裁剪后的图片
				document.querySelector('#confirmApplyClip').addEventListener('click', function() {
					//隐藏提示框
					$("#applyClipTip").addClass("hidden");
					cropImage.clip(false);
					imgData = cropImage.getClipImgData();
					recognizeImg(function() {
						changeContent(true);
					}, function(error) {
						tips(JSON.stringify(error), true);
					});
				});
			}

			function showImgDataLen(imgData) {
				var len = imgData.length;
				var sizeStr = len + 'B';

				if (len > 1024 * 1024) {
					sizeStr = (Math.round(len / (1024 * 1024))).toString() + 'MB';
				} else if (len > 1024) {
					sizeStr = (Math.round(len / 1024)).toString() + 'KB';
				}

				tips('处理后大小：' + sizeStr);
			}

			function tips(msg, isAlert) {
				if (isAlert) {
					alert(msg);
				} else {
					toast(msg);
				}
			}

			function toast(message) {
				console.log("toast");
				var CLASS_ACTIVE = 'mui-active';
				var duration = 2000;
				var toastDiv = document.createElement('div');

				toastDiv.classList.add('mui-toast-container');
				toastDiv.innerHTML = `<div class="mui-toast-message">${message}</div>`;
				toastDiv.addEventListener('webkitTransitionEnd', () => {
					if (!toastDiv.classList.contains(CLASS_ACTIVE)) {
						toastDiv.parentNode.removeChild(toastDiv);
						toastDiv = null;
					}
				});
				// 点击则自动消失
				toastDiv.addEventListener('click', () => {
					toastDiv.parentNode.removeChild(toastDiv);
					toastDiv = null;
				});
				document.body.appendChild(toastDiv);
				toastDiv.classList.add(CLASS_ACTIVE);
				setTimeout(function() {
					toastDiv && toastDiv.classList.remove(CLASS_ACTIVE);
				}, duration);
			}
			
			//裁剪图片，切换UI
			function changeContent(isShowContent) {
				console.log("changeContent", isShowContent);
				if (isShowContent) {
					showContent.classList.remove('hidden');
					clipContent.classList.add('hidden');

					resizeShowImg(imgData);
					showImg.src = imgData;
				} else {
					showContent.classList.add('hidden');
					clipContent.classList.remove('hidden');
				}
			}

			function b64ToBlob(urlData) {
				var arr = urlData.split(',');
				var mime = arr[0].match(/:(.*?);/)[1] || 'image/png';
				// 去掉url的头，并转化为byte
				var bytes = window.atob(arr[1]);

				// 处理异常,将ascii码小于0的转换为大于0
				var ab = new ArrayBuffer(bytes.length);
				// 生成视图（直接针对内存）：8位无符号整数，长度1个字节
				var ia = new Uint8Array(ab);
				for (var i = 0; i < bytes.length; i++) {
					ia[i] = bytes.charCodeAt(i);
				}

				return new Blob([ab], {
					type: mime
				});
			}


			function downloadFile(content) {
				console.log("downloadFile");
				// Convert image to 'octet-stream' (Just a download, really)
				var imageObj = content.replace("image/jpeg", "image/octet-stream");
				window.location.href = imageObj;
			}

			function recognizeImg(success, error) {
				// 里面正常有：裁边，摆正，梯形矫正，锐化等算法操作
				success();
			}

			var showToast = false;
			var afterCanvasImageHide = true;
			var uploadImageUrl;
			//保存截图
			function saveScreenShot() {
				// 获取想要转换的dom节点
				// var dom = document.querySelector('body');
				var dom = document.getElementById('img-wrap');
				var box = window.getComputedStyle(dom);

				// dom节点计算后宽高
				var width = this.parseValue(box.width);
				var height = this.parseValue(box.height);

				// 获取像素比
				var scaleBy = this.getDpr();

				// 创建自定义的canvas元素
				var canvas = document.createElement('canvas');

				// 设置canvas元素属性宽高为 DOM 节点宽高 * 像素比
				canvas.width = width * scaleBy;
				canvas.height = height * scaleBy;

				// 设置canvas css 宽高为DOM节点宽高
				canvas.style.width = width + 'px';
				canvas.style.height = height + 'px';

				// 获取画笔
				var context = canvas.getContext('2d');

				// 将所有绘制内容放大像素比倍
				context.scale(scaleBy, scaleBy);

				// 设置需要生成的图片的大小，不限于可视区域（即可保存长图）
				var w = document.getElementById('final-page').style.width;
				var h = document.getElementById('final-page').style.height;

				html2canvas(dom, {
					tainttest: true,
					allowTaint: true,
					width: w,
					height: h,
					useCORS: true
				}).then(function(canvas) {
					// 将canvas转换成图片渲染到页面上
					uploadImageUrl = canvas.toDataURL('image/png'); // base64数据
					var image = new Image();
					image.crossOrigin = 'Anonymous';
					image.src = uploadImageUrl;
					document.getElementById('shareImg').appendChild(image);
					
					//保存贺卡宽高
					cardWidth = image.width;
					cardHeight = image.height;
					// document.getElementById('shareImg').style -= "display: none;"
					// main.classList.add('hidden');
					// finalpage.classList.remove('hidden');
					//跳转到最后一页
					GoToFinalPage(image);
				});
			}

			function GoToFinalPage(image) {
				//跳转页面
				$("#main").addClass("hidden");
				finalpage.classList.remove('hidden');
				// 同时上传截图
				// downloadFile(imgData);
				upload(function() {
					tips('Successfully Upload');
				});

				isCardCreated = true;

				screenWidth = document.documentElement.clientWidth,
					screenHeight = document.documentElement.clientHeight,
					style = '';
				// finalimg.src = imgData;
				// finalimg.src = '';
				// 上传图片的宽高比
				// var proportion = showImg.width / showImg.height;
				// console.log("showImg.height:" + showImg.height);
				// console.log("height:" + showImg.height/screenHeight);
				// console.log("width:" + showImg.width/screenWidth);

				if (screenWidth >= screenHeight) {
					//如果图片高更接近屏幕高
					if (showImg.height / screenHeight >= showImg.width / screenWidth) {
						//只设置height，图片按比例缩放
						style += "height:" + screenHeight + "px;";
						// style += "width:" + width + "px;";不用设置width
						// console.log("style 0: ", style);
					}
					//如果图片宽更接近屏幕宽
					else {
						style += "width:" + screenWidth + "px;";
						// console.log("style 1: ", style);
					}
				} else {
					// if(finalimg.height>=height)
					// style += "width:" + width * proportion + "px;"; // 注意旋转后的宽高切换
					// style += "height:" + width + "px;";
					// style += "-webkit-transform: rotate(90deg); transform: rotate(90deg);";
					// // 注意旋转中点的处理
					// style += "-webkit-transform-origin: " + width / 2 + "px " + width / 2 + "px;";
					// style += "transform-origin: " + width / 2 + "px " + width / 2 + "px;";
					// console.log("style 2: ", style, proportion);

					//生成时竖屏等待横屏后再操作
					//todo
				}
				// console.log(style);
				image.style.cssText = style;
			};

			function upload(success, error) {

				success();

				var formData = new FormData();

				formData.append("photoUrl", uploadImageUrl);
				formData.append("cId", cid);
				formData.append("uId", uid);
				console.log("cardWidth".cardWidth);
				console.log("cardHeight".cardHeight);
				formData.append("cardWidth", cardWidth);
				formData.append("cardHeight", cardHeight);

				formData.append("modelPosArr", modelPosArr);

				$.ajax({
					url: domainName + 'yida-ar-admin/public/index.php/yida',
					async: false,
					type: "POST",
					data: formData,
					dataType: "json",
					processData: false,
					contentType: false,
					success: function(data) {
						console.log(data);
					},
					error: function(xhr) {
						console.log("error");
					}
				});
			}
			/**
			 * 将传入值转为整数
			 * @param value
			 * @returns {number}
			 */
			function parseValue(value) {
				return parseInt(value, 10);
			}

			/**
			 * 根据 window.devicePixelRatio 获取像素比
			 * @returns {number}
			 * @constructor
			 */
			function getDpr() {
				// console.log("getDpr");
				if (window.devicePixelRatio && window.devicePixelRatio > 1) {
					return window.devicePixelRatio;
				}
				return 1;
			}


			/* 场景 */
			function initScene() {
				scene = new THREE.Scene();

				//显示三维坐标系
				// var axis = new THREE.AxisHelper(3); 
				// scene.add(axis);
			}

			/* 相机 */
			function initCamera() {
				// camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 10000);
				// camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 10000);
				camera = new THREE.PerspectiveCamera(45, $("#img-wrap").width() / $("#img-wrap").height(), 1, 10000);
				camera.position.set(0, 0, 10);

				camera.lookAt(new THREE.Vector3(0, 0, 0));
				// camera.fov = 0.1;
			}

			/* 渲染器 */
			function initRender() {

				// renderer = new THREE.WebGLRenderer({antialias: true});
				// console.log("width", $("#img-wrap").width());
				// renderer.setSize(window.innerWidth, window.innerHeight);

				// renderer.setSize(50px,70px);
				// renderer.setClearColor(0x0E3866);

				//给各个模型添加canvas
				for (var i = 0; i < modelCount; i++) {
					renderer = new THREE.WebGLRenderer({
						antialias: true,
						alpha: true
					});
					// 设置模型所在画布大小
					renderer.setSize($("#img-wrap").width(), $("#img-wrap").height());
					// console.log("modelCount", i);
					// var containerCanvas = document.getElementById('addedModel_' + i);
					// var clonedNode = renderer.domElement.cloneNode(true); // 克隆节点
					// containerCanvas.appendChild(clonedNode);
					$("#addedModel_" + i).append(renderer.domElement);
				}
			}

			/* 灯光 */
			function initLight() {
				scene.add(new THREE.AmbientLight(0xffffff));
			}

			/* 控制器  控制模型的旋转*/
			function initControls() {
				controls = new THREE.OrbitControls(camera, renderer.domElement);
				/* 属性参数默认 */
			}
			/* 场景中的内容 */
			function initContent(scene, camera, renderer, i) {
				console.log("scene.name", scene.name);
				// 加载 glTF 格式的模型
				let loader = new THREE.GLTFLoader(); /*实例化加载器*/
				// console.log("addedModels length",$("#addedModels").children().length);
				// for (var i = 0; i < $("#addedModels").children().length; i++) {
				var modelUrl = domainName + 'ARCardAssets/' + cid + '/Element_3D/Model_' + i + '.glb';
				// var modelUrl = '../model/Model_0.glb';
				console.log("modelUrl", modelUrl);
				loader.load(modelUrl, function(
					obj) {
					//让模型居中
					//注意，gltf要用obj.scene而不是obj
					var box = new THREE.Box3().setFromObject(obj.scene);
					var boundingBoxSize = box.max.sub(box.min);
					var height = boundingBoxSize.y;
					// console.log("boundingBoxSize.y",height);
					obj.scene.position.y = -height / 2;

					scene.add(obj.scene);

					animate(scene, camera, renderer);
					// document.getElementById('model-canvas').style.display = 'none';
				}, function(xhr) {
					// var X= this.getBoundingClientRect().left;
					console.log((xhr.loaded / xhr.total * 100) + '% loaded');
					if (i == $("#addedModels").children().length - 1 && xhr.loaded / xhr.total == 1) {
						modelLoaded = true;
						console.log("Model loaded done");
					}
				}, function(error) {
					console.log('load error!' + error);
				});
				// }
				// molion.tech\YiDaAR\ARCardAssets\0\Element_3D
				// https://molion.tech/test/YiDaAR/ARCardAssets/01
			}

			var modelPosArr;
			// 获取模型的 X,Y坐标
			function getModelPos() {
				if ($("#addedModel_0").length > 0) {
					console.log("getModelPos");
					modelPosArr = new Array();
					for (var i = 0; i < $("#addedModels").children().length; i++) {
						idx = i;
						//判断是否选中
						if ($("#modelWrap").children().eq(idx).children().eq(0).hasClass("hidden")) {
							//选中
							//position()计算的是相对父物体的位置
							// 模型位置取div中点 并四舍五入取整
							modelPos_X = $("#addedModel_" + idx).position().left + $("#addedModel_" + idx).width() / 2;
							modelPos_Y = $("#addedModel_" + idx).position().top + $("#addedModel_" + idx).height() / 2;
							// console.log("modelPos_X", modelPos_X);
							// console.log("modelPos_Y", modelPos_Y);
							// 将坐标原点放到$("#modelWrap")中心,转换坐标
							modelPos_X = Math.round(modelPos_X - $("#img-wrap").width() / 2);
							modelPos_Y = -Math.round(modelPos_Y - $("#img-wrap").height() / 2);

							console.log("new modelPos_X", modelPos_X);
							console.log("new modelPos_Y", modelPos_Y);
							//用于返回后台的数据
							var modelObj = '{"model_' + idx + '": {"modelPos_X": ' + modelPos_X + ',"modelPos_Y": ' + modelPos_Y + ' }}';
							modelPosArr
								.push(modelObj);
						} else {
							//未选中
							//用于返回后台的数据
							var modelObj = '{"model_' + idx + '": {"modelPos_X": ' + (-9999) + ',"modelPos_Y": ' + (-9999) + ' }}';
							modelPosArr.push(modelObj);
						}
					}
					modelPosArr = "[" + modelPosArr + "]";

					// console.log($("#show-img").position());
					// console.log("offset_X",offset_X);
					// console.log("offset_Y",offset_Y);
				}
			}
			/* 初始化 */
			function initModel() {
				// initScene();
				// initCamera();
				// initRender();

				for (var i = 0; i < modelCount; i++) {
					// 加载模型的方法
					var scene, camera, renderer;
					//initScene
					scene = new THREE.Scene();
					scene.name = "scene_" + i;
					// console.log("scene.name",scene.name);

					//initCamera
					camera = new THREE.PerspectiveCamera(45, $("#img-wrap").width() / $("#img-wrap").height(), 1, 10000);
					camera.name = "camera_" + i;
					// console.log("camera.name",camera.name);
					camera.position.set(0, 0, 10);
					camera.lookAt(new THREE.Vector3(0, 0, 0));

					//initRender
					renderer = new THREE.WebGLRenderer({
						antialias: true,
						alpha: true
					});
					renderer.name = "renderer_" + i;
					// console.log("renderer.name",renderer.name);
					// 设置模型所在画布大小
					renderer.setSize($("#img-wrap").width(), $("#img-wrap").height());
					// console.log("modelCount", i);

					//给各个模型添加canvas
					$("#addedModel_" + i).append(renderer.domElement);

					//initLight
					scene.add(new THREE.AmbientLight(0xffffff));

					initContent(scene, camera, renderer, i);
					// // 加载 glTF 格式的模型
					// let loader = new THREE.GLTFLoader(); /*实例化加载器*/
					// var modelUrl = 'https://molion.tech/test/YiDaAR/ARCardAssets/' + cid + '/Element_3D/Model_' + i + '.glb';
					// // var modelUrl = '../model/Model_0.glb';
					// // console.log("modelUrl", modelUrl);
					// loader.load(modelUrl, function(
					// 	obj) {
					// 	console.log("scene.name", scene.name);
					// 	console.log("obj", obj);
					// 	//让模型居中
					// 	//注意，gltf要用obj.scene而不是obj
					// 	var box = new THREE.Box3().setFromObject(obj.scene);
					// 	var boundingBoxSize = box.max.sub(box.min);
					// 	var height = boundingBoxSize.y;
					// 	// console.log("boundingBoxSize.y",height);
					// 	obj.scene.position.y = -height / 2;

					// 	scene.add(obj.scene);
					// 	// document.getElementById('model-canvas').style.display = 'none';
					// }, function(xhr) {
					// 	// var X= this.getBoundingClientRect().left;
					// 	console.log((xhr.loaded / xhr.total * 100) + '% loaded');
					// 	if (i == $("#addedModels").children().length - 1 && xhr.loaded / xhr.total == 1) {
					// 		modelLoaded = true;
					// 		console.log("Model loaded done");
					// 	}
					// }, function(error) {
					// 	console.log('load error!' + error);
					// });

					// animate(scene, camera, renderer);
				}

				// initLight();
				//控制移动
				// initControls();
				// initContent();
				// initGui();

				/* 监听事件 */
				window.addEventListener('resize', onWindowResize, false);
			}

			function animate(scene, camera, renderer) {
				requestAnimationFrame(function() {
					animate(scene, camera, renderer);
				});
				renderer.render(scene, camera);
				// update();
			}

			// function render() {
			// 	renderer.render(scene, camera);

			// 	console.log(camera.position.x, camera.position.y, camera.position.z);
			// }

			function GetPosition(point) {
				var pos = point.getWorldPosition();
				var worldVector = new THREE.Vector3(pos.x, pos.y, pos.z);
				var vec2 = worldVector.project(camera);
				var halfWidth = window.innerWidth / 2;
				var halfHeight = window.innerHeight / 2;
				return {
					"left": vec2.x * halfWidth + halfWidth,
					"top": -vec2.y * halfHeight + halfHeight
				};
			}

			/* 初始加载 */
			function initialLoad() {
				//modelLoaded 防止二次加载
				if (modelLoaded == false) {
					console.log("three init start...");

					setModelDraggableArea();
					initModel();
					// animate();

					// console.log("three init send...");
				}
			};


			//设置Model拖动范围，放在这里因为此时$("#img-wrap")才确定宽高
			function setModelDraggableArea() {
				//坐标原点在屏幕左上角
				//左上角
				var containment_X_1 = $("#img-wrap").offset().left;
				var containment_Y_1 = $("#img-wrap").offset().top;
				//右下角
				var containment_X_2 = containment_X_1 + $("#img-wrap").width();
				var containment_Y_2 = containment_Y_1 + $("#img-wrap").height();
				//生成模型dom
				//样例: <!-- <div id="addedModel" class="addedModelElement"></div> -->					
				for (var i = 0; i < modelCount; i++) {
					var idx = i;
					var modelId = "addedModel_" + idx;
					var modelDivDom = $('<div id="addedModel_' + idx +
						'" class="addedModelElement hidden"></div>');
					// console.log(modelDivDom)
					$("#addedModels").append($(modelDivDom));
					// console.log('????','"#addedModel_'+idx+'"')
					$("#" + modelId).draggable({
						containment: [containment_X_1, containment_Y_1, containment_X_2, containment_Y_2],
						//设置拖拽偏移量
						cursorAt: {
							top: 0,
							left: 0
						},
					});
				}
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize(window.innerWidth, window.innerHeight);
			}
		</script>
	</body>

</html>
